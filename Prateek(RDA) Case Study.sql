CREATE DATABASE RETAIL_DATA_ANALYSIS
USE RETAIL_DATA_ANALYSIS
SELECT*FROM CUSTOMER
SELECT*FROM PROD_CAT_INFO
SELECT*FROM TRANSACTIONS 


--DATA PREPARATION AND UNDERSTANDING

--Q1:WHAT IS TOTAL NO. OF ROWS IN EACH OF THE 3 TABLES IN DATABASE?
SELECT'CUSTOMER' AS TBL_NAME,COUNT(*) AS NO_OF_RECORDS FROM [DBO].[CUSTOMER] UNION ALL
SELECT 'PROD_CAT_INFO',COUNT(*)FROM[DBO].[PROD_CAT_INFO] UNION ALL
SELECT 'TRANSACTIONS',COUNT(*)FROM[DBO].[TRANSACTIONS] 

--Q2:WHAT IS TOTAL NO. OF TRANSACTIONS THAT HAVE A RETURN?
SELECT COUNT(QTY) AS RETURNS_NO FROM TRANSACTIONS WHERE QTY<0

--Q3:AS YOU WOULD HAVE NOTICED,THE DATES PROVIDED ACROSS THE DATASETS ARE NOT IN A CORRECT FORMAT .AS FIRST STEPS,PLS CONVERT
--THE DATE VARIABLES INTO VALID DATE FORMATS BEFORE PROCEEDING AHEAD.
UPDATE TRANSACTIONS SET TRAN_DATE=CONVERT(DATE,TRAN_DATE,105)


--Q4:WHAT IS TIME RANGE OF TRANSACTIONS DATA AVAILABLE FOR ANALYSIS? SHOW THE OUTPUT IN NUMBER OF DAYS, MONTH AND YEARS SIMULTANEOUSLY
--IN DIFFERENT COLUMNS.
SELECT CUST_ID, DATEDIFF(DAY,MIN((CONVERT(DATE,TRAN_DATE,105))),MAX(CONVERT(DATE,TRAN_DATE,105))) AS DAYS,
DATEDIFF(MONTH,MIN((CONVERT(DATE,TRAN_DATE,105))),MAX(CONVERT(DATE,TRAN_DATE,105))) AS MONTHS,
DATEDIFF(YEAR,MIN((CONVERT(DATE,TRAN_DATE,105))),MAX(CONVERT(DATE,TRAN_DATE,105))) AS YEARS 
FROM TRANSACTIONS GROUP BY CUST_ID


--Q5:WHICH PRODUCT CATEGORY DOES SUB-CATEGORY "DIY" BELONG TO?
SELECT PROD_CAT AS PROD_CATEGORY,PROD_SUBCAT AS PROD_SUBCATEGORY FROM PROD_CAT_INFO WHERE PROD_SUBCAT LIKE 'DIY'


/*DATA ANALYSIS*/

--Q1:WHICH CHANNEL IS MOST FREQUENTLY USED FOR TRANSACTIONS?
SELECT STORE_TYPE AS CHANNELS,COUNT(CUST_ID) AS FREQUENTLY_USED  FROM  TRANSACTIONS 
GROUP BY STORE_TYPE ORDER BY FREQUENTLY_USED DESC 


--CHANNEL_ESHOP IS MOST FREQUENTLY USED WITH COUNT OF 9311.


--Q2:WHAT IS THE COUNT OF MALE AND FEMALE CUSTOMERS IN DATABASE?
SELECT COUNT(CASE WHEN GENDER='M' THEN 1 END) AS COUNT_MALE,
COUNT(CASE WHEN GENDER='F' THEN 1 END) AS COUNT_FEMALE FROM CUSTOMER


--Q3:FROM WHICH CITY DO WE HAVE THE MAXIMUM NUMBER OF CUSTOMERS AND HOW MANY?
SELECT COUNT(CUSTOMER_ID) AS COUNT_OF_CUSTOMER,CITY_CODE FROM CUSTOMER 
GROUP BY CITY_CODE ORDER BY COUNT_OF_CUSTOMER DESC

--CITY_CODE 3 IS HAVING HIGHEST NO. OF CUSTOMERS WITH COUNT OF 595. 


--Q4:HOW MANY SUB-CATEGORIES ARE THERE UNDER BOOKS CATEGORY?
SELECT PROD_CAT,COUNT(PROD_SUBCAT) AS PROD_SUBCATCOUNT FROM PROD_CAT_INFO WHERE PROD_CAT LIKE'BOOKS' 
GROUP BY PROD_CAT


--Q5:WHAT IS MAXIMUM QUANTITY OF PRODUCTS EVER ORDERED?
SELECT  PROD_CAT ,COUNT(PROD_SUBCAT_CODE) AS COUNT_OF_PRODUCT FROM TRANSACTIONS AS A LEFT JOIN PROD_CAT_INFO AS B 
ON A.PROD_CAT_CODE=B.PROD_CAT_CODE GROUP BY PROD_CAT

--BOOKS IS THE MAXIMUM QUANTITY OF PRODUCT EVER ORDERED.


--Q6:WHAT IS THE NET TOTAL REVENUE GENERATED IN CATEGORIES ELECTRONICS AND BOOKS?
SELECT PROD_CAT_CODE AS PRODUCT_CODE, SUM(CAST(TOTAL_AMT AS NUMERIC))-SUM(CAST(TAX  AS NUMERIC)) AS NET_TOTAL_REVENUE FROM TRANSACTIONS
WHERE PROD_CAT_CODE IN ('3', '5') GROUP BY PROD_CAT_CODE;

--PRD_CAT_CODE (3)='ELECTRONICS'
--PRD_CAT_CODE (5)='BOOKS'


--Q7:HOW MANY CUSTOMERS HAVE >10 TRANSACTIONS WITH US, EXCLUDING RETURNS?
SELECT CUST_ID, COUNT(CUST_ID) AS CUST_TRANS FROM TRANSACTIONS WHERE QTY>=0  GROUP BY CUST_ID 
HAVING COUNT(CUST_ID)>10 


--Q8:WHAT IS COMBINED REVENUE EARNED FROM "ELECTRONICS" AND "CLOTHING" CATEGORIES FROM FLAGSHIP STORES?
SELECT PROD_CAT_CODE,SUM(CAST(TOTAL_AMT AS NUMERIC)) AS REVENUE,STORE_TYPE FROM TRANSACTIONS WHERE PROD_CAT_CODE IN ('1','3')
AND STORE_TYPE ='FLAGSHIP STORE' GROUP BY STORE_TYPE ,PROD_CAT_CODE

--TOTAL REVENUE OF BOTH 'ELECTRONIC' AND 'CLOTHING' FROM FLAGSHIP STORE = "34,09,582".


--Q9:WHAT IS TOTAL REVENUE GENERATED FROM 'MALE' CUSTOMER IN 'ELECTRONICS' CATEGORY? OUTPUT SHOULD DISPLAY TOTAL REVENUE BY PROD_SUB_CAT?
SELECT GENDER,PROD_SUBCAT_CODE,SUM(CAST(TOTAL_AMT AS NUMERIC)) AS TOTAL_REVENUE FROM CUSTOMER INNER JOIN TRANSACTIONS ON CUSTOMER_ID=CUST_ID 
WHERE GENDER='M' AND PROD_CAT_CODE=3 GROUP BY GENDER,PROD_SUBCAT_CODE


--Q10:WHAT IS PERCENTAGE OF SALES AND RETURNS BY PRODUCT SUB-CATEGORY ,DISPLAY ONLY TOP 5 CATEGORIES IN TERMS OF SALES?
SELECT  TOP 5 PROD_SUBCAT,SUM(CAST(TOTAL_AMT AS NUMERIC)) AS TOTAL_SALES,
SUM(CAST(TOTAL_AMT AS NUMERIC)) / 48579882*100 AS SALES_PERCENTAGE,
(SELECT SUM(CASE WHEN CAST(TOTAL_AMT AS NUMERIC)<0 THEN CAST(TOTAL_AMT AS NUMERIC)
ELSE 0 END))/5874132*100 AS RETURN_PERCENTAGE
FROM PROD_CAT_INFO AS A LEFT JOIN TRANSACTIONS AS B 
ON A.PROD_SUB_CAT_CODE=B.PROD_SUBCAT_CODE 
AND A.PROD_CAT_CODE=B.PROD_CAT_CODE GROUP BY PROD_SUBCAT  ORDER BY TOTAL_SALES DESC

--SUM(CAST(TOTAL_AMT AS NUMERIC))='48579882'
--(SELECT SUM(CASE WHEN CAST(TOTAL_AMT AS NUMERIC)<0 THEN CAST(TOTAL_AMT AS NUMERIC)
--ELSE 0 END)TOTAL_AMT FROM TRANSACTIONS)='5874132'  





--Q11:FOR ALL CUSTOMERS AGED BETWEEN 25 TO 35 YEARS FIND WHAT IS THE NET TOTAL REVENUE GENERATED BY THESE CONSUMERS IN LAST
--30 DAYS OF TRANSACTIONS FROM MAX TRANSACTION DATE AVAILABLE IN THE DATA?
SELECT DOB,TAX, SUM(CAST(TOTAL_AMT AS NUMERIC)-TAX) AS NET_TOTAL_REVENUE  FROM TRANSACTIONS AS A INNER JOIN CUSTOMER AS B
ON A.CUST_ID=B.CUSTOMER_ID WHERE TRAN_DATE>=DATEADD(DAY,-30,(SELECT MAX(TRAN_DATE) FROM TRANSACTIONS))  
GROUP BY GROUPING SETS((DOB,TAX,TOTAL_AMT) ,() )
HAVING (SELECT DATEDIFF(YEAR,MIN((CONVERT(DATE,DOB,105))),MAX(CONVERT(DATE,TRAN_DATE,105))) AS YEARS)
BETWEEN 25 AND 35           



--Q12:WHICH PRODUCT HAS SEEN THE MAX VALUE OF RETURNS IN LAST 3 MONTHS OF TRANSACTIONS?
SELECT PROD_CAT_CODE,SUM(CAST(QTY AS NUMERIC)) AS RETURN_VALUE FROM TRANSACTIONS WHERE PROD_CAT_CODE IN ('6','5','4','3','2','1') AND  QTY<0  
GROUP BY PROD_CAT_CODE ORDER BY PROD_CAT_CODE 

--PRODUCT CODE 5 (BOOKS) HAVE MAX RETURNS.


--Q13:WHICH STORE-TYPE SELLS THE MAXIMUM PRODUCTS;BY VALUE OF SALES AMOUNT  AND BY QUANTITY SOLD?
SELECT STORE_TYPE,SUM(CAST(PROD_CAT_CODE AS NUMERIC)) AS PRODUCTS,SUM(CAST(TOTAL_AMT AS NUMERIC)) AS SALES,
SUM(CAST(QTY AS NUMERIC))AS QTY_SOLD 
FROM TRANSACTIONS GROUP BY STORE_TYPE

--BY VALUE OF SALES AND QUANTITY SOLD E-SHOP HAS SOLD MAX PRODUCTS.


--Q14:WHAT ARE THE CATEGORIES FOR WHICH AVERAGE REVENUE IS ABOVE OVERALL AVERAGE?
SELECT PROD_CAT, AVG(CAST(TOTAL_AMT AS NUMERIC)) AS AVG_REVENUE FROM TRANSACTIONS AS A INNER JOIN PROD_CAT_INFO AS B  
ON A.PROD_CAT_CODE=B.PROD_CAT_CODE GROUP BY PROD_CAT HAVING (SELECT AVG(CAST(TOTAL_AMT AS NUMERIC)) AS AVG_REVENUE)>2114.62

--SELECT AVG(CAST(TOTAL_AMT AS NUMERIC)='2114.62'(OVERALL AVERAGE)

 

--Q15:FIND AVERAGE AND TOTAL REVENUE BY EACH SUBCATEGORY FOR THE CATEGORIES WHICH ARE AMONG TOP 5 CATEGORIES IN TERMS OF QUANTITY SOLD?
SELECT TOP 5 PROD_SUBCAT_CODE,SUM(CAST(TOTAL_AMT AS NUMERIC)) AS TOTAL_REVENUE, AVG(CAST(TOTAL_AMT AS NUMERIC)) AS AVG_REVENUE,
SUM(CAST(QTY AS NUMERIC)) AS QTY_SOLD
FROM TRANSACTIONS GROUP BY  PROD_SUBCAT_CODE ORDER BY QTY_SOLD DESC




















